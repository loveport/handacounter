
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HANDAë¶€ìŠ¤</title>

  <!-- âœ… Firebase ìŠ¤í¬ë¦½íŠ¸: ì¤‘ë³µ ì œê±° ë° ìˆœì„œ ìœ ì§€ -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <style>
    body { font-family: sans-serif; margin: 0; padding: 1rem; background: #e6f2ff; }
    h1 { text-align: center; margin-bottom: 1rem; }
    nav { display: flex; justify-content: center; gap: 1rem; margin-bottom: 1.5rem; }
    nav 
button {
  background-color: white;
  color: #003366;
  border: 1px solid #b3d9ff;
  border-radius: 6px;
  padding: 0.5rem 1rem;
  font-size: 1rem;
  cursor: pointer;
  touch-action: manipulation;
  transition: transform 0.1s ease, background-color 0.2s ease;
}
button:active {
  transform: scale(0.96);
  background-color: #d6ecff;
}

button:active {
  transform: scale(0.96);
  background-color: #d6ecff;
}
  touch-action: manipulation; padding: 0.5rem 1rem; font-size: 1rem; }
    section { display: none; }
    section.active { display: block; }
    .form-group {
      margin-bottom: 1rem;
      width: 100%;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
    }
    input, select {
      width: 100%;
      box-sizing: border-box;
      padding: 0.5rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    .product-list, .product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 1rem;
    }
    .product-card, .product {
      background: white;
      padding: 1rem;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      text-align: center;
    }
    .product {
      border: 1px solid #b3d9ff;
      cursor: pointer;
      transition: background-color 0.2s, box-shadow 0.2s;
    }
    .product:hover {
      background-color: #f0f8ff;
      box-shadow: 0 0 8px rgba(179, 217, 255, 0.5);
    }
    .product-card img, .product img {
      width: 100%;
      height: 100px;
      object-fit: cover;
      border-radius: 5px;
      margin-bottom: 0.5rem;
    }
    .btn-group { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
    .cart, .sales {
      background: #fff;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-top: 1rem;
    }
    .cart-items {
  max-height: 50vh;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}
.cart-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }
    .cart-controls 
button {
  background-color: white;
  color: #003366;
  border: 1px solid #b3d9ff;
  border-radius: 6px;
  padding: 0.5rem 1rem;
  font-size: 1rem;
  cursor: pointer;
  touch-action: manipulation;
  transition: transform 0.1s ease, background-color 0.2s ease;
}
button:active {
  transform: scale(0.96);
  background-color: #d6ecff;
}

button:active {
  transform: scale(0.96);
  background-color: #d6ecff;
}
  touch-action: manipulation; margin-left: 5px; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
    }
    th, td { border: 1px solid #ccc; padding: 0.5rem; }
    th { background: #f0f0f0; }
    .download-btn {
      margin: 1rem 0;
      padding: 0.5rem 1rem;
      font-size: 1rem;
    }
    
button {
  background-color: white;
  color: #003366;
  border: 1px solid #b3d9ff;
  border-radius: 6px;
  padding: 0.5rem 1rem;
  font-size: 1rem;
  cursor: pointer;
  touch-action: manipulation;
  transition: transform 0.1s ease, background-color 0.2s ease;
}
button:active {
  transform: scale(0.96);
  background-color: #d6ecff;
}

button:active {
  transform: scale(0.96);
  background-color: #d6ecff;
}
  touch-action: manipulation;
      background-color: white;
      color: #003366;
      border: 1px solid #b3d9ff;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    button:hover {
      background-color: #f0f8ff;
    }
    button, .download-btn {
      font-size: 1rem;
      padding: 1rem;
    }
  
  section { display: none; }
  section.active { display: block; }
</style>
</head>
<body>
  <h1>HANDAë¶€ìŠ¤</h1>
  <nav>
    <button onclick="showSection('manage')">ìƒí’ˆ ê´€ë¦¬</button>
    <button onclick="showSection('order')">ì£¼ë¬¸ ì²˜ë¦¬</button>
    <button onclick="showSection('sales')">ë§¤ì¶œ ê´€ë¦¬</button>
  </nav>

  <section id="manage" class="active">
    <div class="form-group"><label for="name">ìƒí’ˆëª…</label><input type="text" id="name" /></div>
    <div class="form-group"><label for="price">ê°€ê²©</label><input type="number" id="price" /></div>
    <div class="form-group"><label for="category">ì¹´í…Œê³ ë¦¬</label><input type="text" id="category" /></div>
    <div class="form-group"><label for="stock">ì¬ê³  ìˆ˜ëŸ‰</label><input type="number" id="stock" /></div>
    <div class="form-group"><label for="image">ì´ë¯¸ì§€</label><input type="file" id="image" accept="image/*" /></div>
    <div class="form-group"><button onclick="addProduct()">ìƒí’ˆ ë“±ë¡</button></div>
    <div class="product-list" id="productList"></div>
  </section>

  <section id="order">
    <div class="product-grid" id="productGrid"></div>
    <div class="cart" id="cart">
      <h2>ì¥ë°”êµ¬ë‹ˆ</h2>
      <div id="cartItems"></div>
      <div class="cart-total" id="cartTotal">ì´í•©: 0ì›</div>
      <div class="payment">
        <button onclick="completeOrder('í˜„ê¸ˆ')">í˜„ê¸ˆ ê²°ì œ</button>
        <button onclick="completeOrder('ê³„ì¢Œì´ì²´')">ê³„ì¢Œì´ì²´</button>
      </div>
    </div>
  </section>

  <section id="sales">
    <div class="sales">
      <h2>ë§¤ì¶œ ë‚´ì—­</h2>
      <button class="download-btn" onclick="downloadCSV()">CSV ë‹¤ìš´ë¡œë“œ</button>
      <button class="download-btn" onclick="resetSales()">ë§¤ì¶œ ì´ˆê¸°í™”</button>
      <div id="salesList"></div>
      <h3>ì¼ë³„ ë§¤ì¶œ í†µê³„</h3>
      <div id="dailyStats"></div>
    </div>
  </section>

  <!-- âœ… JavaScript ë¡œì§ í¬í•¨ -->
  <script>

const firebaseConfig = {
  apiKey: "AIzaSyBgtMaVNPSUQ3qQKu7Ted3KoZn_dgdxE4k",
  authDomain: "handacounter.firebaseapp.com",
  projectId: "handacounter",
  storageBucket: "handacounter.appspot.com",
  messagingSenderId: "68271064287",
  appId: "1:68271064287:web:180813a3a6802b5b90956a"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
firebase.firestore().enablePersistence({synchronizeTabs: true})
  .then(() => console.log("ğŸ”¥ Firestore ì˜¤í”„ë¼ì¸ ìºì‹œ í™œì„±í™”"))
  .catch(err => console.warn("â—ì˜¤í”„ë¼ì¸ ìºì‹œ ë¶ˆê°€:", err.code));

let products = [];
let cart = [];
let sales = JSON.parse(localStorage.getItem('sales') || '[]');
let selectedProductIndex = null;

function showSection(id) {
  document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if (id === 'manage') 
document.addEventListener("DOMContentLoaded", () => {
  showSection('manage');
});
loadProductsFromFirestore();
  if (id === 'order') renderOrder();
  if (id === 'sales') renderSales();
}

function loadProductsFromFirestore() {
  db.collection("products").get().then(snapshot => {
    products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    localStorage.setItem('products', JSON.stringify(products));
    renderProducts();
    renderOrder();
  });
}

function addProduct() {
  const name = document.getElementById("name").value;
  const price = parseInt(document.getElementById("price").value);
  const category = document.getElementById("category").value;
  const stock = parseInt(document.getElementById("stock").value);
  const imageInput = document.getElementById("image");

  if (!name || !price || !category || !stock) return alert("ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”");

  const save = (imageUrl = '') => {
    const product = { name, price, category, stock, imageUrl };

    if (selectedProductIndex !== null) {
      product.id = products[selectedProductIndex].id;
      products[selectedProductIndex] = product;
      db.collection('products').doc(product.id).set(product).then(() => {
        localStorage.setItem('products', JSON.stringify(products));
        selectedProductIndex = null;
        clearForm();
        
document.addEventListener("DOMContentLoaded", () => {
  showSection('manage');
});
loadProductsFromFirestore();
      });
    } else {
      db.collection('products').add(product).then(docRef => {
        product.id = docRef.id;
        products.push(product);
        localStorage.setItem('products', JSON.stringify(products));
        clearForm();
        
document.addEventListener("DOMContentLoaded", () => {
  showSection('manage');
});
loadProductsFromFirestore();
      });
    }
  };

  if (imageInput.files && imageInput.files[0]) {
    const reader = new FileReader();
    reader.onload = function (e) {
      save(e.target.result);
      imageInput.value = '';
    };
    reader.readAsDataURL(imageInput.files[0]);
  } else {
    save();
  }
}

function renderProducts() {
  const listEl = document.getElementById("productList");
  listEl.innerHTML = '';
  products.forEach((p, i) => {
    const div = document.createElement("div");
    div.className = "product-card";
    div.innerHTML = `
      <img src="${p.imageUrl || ''}" alt="${p.name}" />
      <strong>${p.name}</strong><br/>${p.price}ì›<br/>ì¹´í…Œê³ ë¦¬: ${p.category}<br/>ì¬ê³ : ${p.stock}
      <div class="btn-group">
        <button onclick="editProduct(${i})">ìˆ˜ì •</button>
        <button onclick="deleteProduct(${i})">ì‚­ì œ</button>
      </div>`;
    listEl.appendChild(div);
  });
}

function renderOrder() {
  const grid = document.getElementById("productGrid");
  grid.innerHTML = '';

  const grouped = {};
  products.forEach(p => {
    if (!grouped[p.category]) grouped[p.category] = [];
    grouped[p.category].push(p);
  });

  Object.keys(grouped).forEach(category => {
    const section = document.createElement("div");
    section.innerHTML = `<h3>${category}</h3>`;
    section.style.marginBottom = "1rem";

    const gridGroup = document.createElement("div");
    gridGroup.className = "product-grid";

    grouped[category].forEach((p, i) => {
      const div = document.createElement("div");
      div.className = "product";
      div.innerHTML = `
        <img src="${p.imageUrl || ''}" />
        <div>${p.name}</div>
        <div>${p.price}ì›</div>
        <div>ì¬ê³ : ${p.stock}</div>
      `;
      div.onclick = () => addToCart(products.indexOf(p));
      gridGroup.appendChild(div);
    });

    section.appendChild(gridGroup);
    grid.appendChild(section);
  });
}

function addToCart(i) {
  const p = products[i];
  if (parseInt(p.stock) <= 0) return alert('ì¬ê³  ì—†ìŒ');
  const item = cart.find(x => x.name === p.name);
  if (item) {
    if (item.qty < parseInt(p.stock)) item.qty++;
  } else {
    cart.push({ ...p, qty: 1 });
  }
  renderCart();
}

function renderCart() {
  const box = document.getElementById('cartItems');
  box.innerHTML = '';
  let total = 0;
  cart.forEach(item => {
    total += item.qty * item.price;
    box.innerHTML += `
      <div class="cart-item">
        <div>${item.name} x ${item.qty} = ${item.qty * item.price}ì›</div>
        <div class="cart-controls">
          <button onclick="updateQty('${item.name}',1)">+</button>
          <button onclick="updateQty('${item.name}',-1)">-</button>
        </div>
      </div>
    `;
  });
  document.getElementById('cartTotal').innerText = `ì´í•©: ${total.toLocaleString()}ì›`;
}

function updateQty(name, delta) {
  const item = cart.find(i => i.name === name);
  if (!item) return;
  const stock = parseInt(products.find(p => p.name === name).stock);
  item.qty += delta;
  if (item.qty <= 0) cart = cart.filter(i => i.name !== name);
  if (item.qty > stock) item.qty = stock;
  renderCart();
}

function completeOrder(method) {
  if (!cart.length) return alert('ì¥ë°”êµ¬ë‹ˆ ë¹„ì–´ìˆìŒ');
  const order = {
    items: cart.map(item => ({ name: item.name, price: item.price, qty: item.qty })),
    total: cart.reduce((sum, i) => sum + i.qty * i.price, 0),
    method,
    date: new Date().toISOString()
  };
  sales.push(order);
  localStorage.setItem('sales', JSON.stringify(sales));
  cart.forEach(i => {
    const p = products.find(p => p.name === i.name);
    p.stock = parseInt(p.stock) - i.qty;
  });
  localStorage.setItem('products', JSON.stringify(products));
  cart = [];
  renderCart();
  renderOrder();
  alert(`ê²°ì œ ì™„ë£Œ (${method})`);
}

function renderSales() {
  sales = JSON.parse(localStorage.getItem('sales') || '[]');
  const salesList = document.getElementById('salesList');
  const dailyStats = document.getElementById('dailyStats');
  salesList.innerHTML = '';
  dailyStats.innerHTML = '';

  if (!sales.length) {
    salesList.innerHTML = '<p>ë§¤ì¶œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
    return;
  }

  const dayStats = {};

  sales.slice().reverse().forEach(sale => {
    const date = new Date(sale.date).toLocaleDateString();

    if (!dayStats[date]) dayStats[date] = { total: 0, items: {} };
    dayStats[date].total += sale.total;
    sale.items.forEach(item => {
      if (!dayStats[date].items[item.name]) dayStats[date].items[item.name] = 0;
      dayStats[date].items[item.name] += item.qty;
    });

    const table = document.createElement('table');
    table.innerHTML = `
      <thead>
        <tr><th colspan="4">${new Date(sale.date).toLocaleString()} - ${sale.method} - ì´ ${sale.total.toLocaleString()}ì›</th></tr>
        <tr><th>ìƒí’ˆëª…</th><th>ìˆ˜ëŸ‰</th><th>ë‹¨ê°€</th><th>í•©ê³„</th></tr>
      </thead>
      <tbody>
        ${sale.items.map(item => `
          <tr><td>${item.name}</td><td>${item.qty}</td><td>${item.price}</td><td>${item.qty * item.price}</td></tr>
        `).join('')}
      </tbody>`;
    salesList.appendChild(table);
  });

  const statTable = document.createElement('table');
  statTable.innerHTML = `
    <thead><tr><th>ë‚ ì§œ</th><th>ì´ ë§¤ì¶œ</th><th>íŒë§¤ ìƒí’ˆ</th></tr></thead>
    <tbody>
      ${Object.entries(dayStats).map(([date, data]) => {
        const itemSummary = Object.entries(data.items)
          .map(([name, qty]) => `${name}(${qty})`)
          .join(', ');
        return `<tr><td>${date}</td><td>${data.total.toLocaleString()}ì›</td><td>${itemSummary}</td></tr>`;
      }).join('')}
    </tbody>`;
  dailyStats.appendChild(statTable);
}

function resetSales() {
  if (confirm("ë§¤ì¶œ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
    localStorage.removeItem("sales");
    sales = [];
    renderSales();
    alert("ë§¤ì¶œì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
  }
}

function downloadCSV() {
  const rows = [["ë‚ ì§œ", "ê²°ì œìˆ˜ë‹¨", "ìƒí’ˆëª…", "ìˆ˜ëŸ‰", "ë‹¨ê°€", "í•©ê³„"]];
  sales.forEach(sale => {
    const date = new Date(sale.date).toLocaleString();
    sale.items.forEach(item => {
      rows.push([date, sale.method, item.name, item.qty, item.price, item.qty * item.price]);
    });
  });
  const csv = rows.map(r => r.join(",")).join("\n");
  const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "sales.csv";
  a.style.display = "none";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function editProduct(i) {
  const p = products[i];
  document.getElementById("name").value = p.name;
  document.getElementById("price").value = p.price;
  document.getElementById("category").value = p.category;
  document.getElementById("stock").value = p.stock;
  selectedProductIndex = i;
}

function deleteProduct(i) {
  const id = products[i].id;
  if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
    db.collection("products").doc(id).delete().then(() => {
      products.splice(i, 1);
      localStorage.setItem('products', JSON.stringify(products));
      renderProducts();
      renderOrder();
    });
  }
}


document.addEventListener("DOMContentLoaded", () => {
  showSection('manage');
});
loadProductsFromFirestore();
</script>
</body>
</html>